# PRD: Escala Simples
## Product Requirements Document

**Vers√£o:** 2.0
**Data:** 28/12/2024
**Status:** Ready for Development

---

## 1. Vis√£o Geral

### 1.1 Problema

Gerentes de restaurantes e lojas gastam 3-5 horas por semana gerenciando escalas de trabalho usando Excel e WhatsApp. Quando um funcion√°rio falta, o gerente perde 30-60 minutos ligando para encontrar cobertura.

### 1.2 Solu√ß√£o

Sistema de gest√£o de escala que:
- Coleta restri√ß√µes de funcion√°rios automaticamente via WhatsApp
- Gera escalas otimizadas com AI
- Facilita trocas de turno entre funcion√°rios
- Notifica todos automaticamente sobre mudan√ßas

### 1.3 Proposta de Valor

```
GERENTE: "Configure uma vez, aprove quando precisar."
FUNCION√ÅRIO: "Diga quando n√£o pode, troque com colegas. Tudo pelo WhatsApp."
```

### 1.4 Usu√°rios

| Tipo | Descri√ß√£o | Canal |
|------|-----------|-------|
| Gerente | Dono ou gerente do estabelecimento | App Mobile (iOS/Android) |
| Funcion√°rio | Colaborador horista | WhatsApp (sem app) |

---

## 2. Arquitetura T√©cnica

### 2.1 Stack

```
FRONTEND:
‚îú‚îÄ‚îÄ React Native + Expo (App do Gerente)
‚îú‚îÄ‚îÄ Web responsivo para links compartilhados
‚îî‚îÄ‚îÄ WhatsApp Business API (interface do funcion√°rio)

BACKEND:
‚îú‚îÄ‚îÄ Google Cloud Platform (GCP)
‚îú‚îÄ‚îÄ Cloud Run (API REST)
‚îú‚îÄ‚îÄ Firestore (banco de dados)
‚îú‚îÄ‚îÄ Cloud Functions (webhooks, jobs agendados)
‚îú‚îÄ‚îÄ Gemini API (processamento de linguagem natural)
‚îî‚îÄ‚îÄ Cloud Tasks (filas de mensagens)

INTEGRA√á√ïES:
‚îú‚îÄ‚îÄ WhatsApp Business Cloud API
‚îú‚îÄ‚îÄ Firebase Auth (autentica√ß√£o)
‚îú‚îÄ‚îÄ Firebase Cloud Messaging (push notifications)
‚îî‚îÄ‚îÄ Twilio (SMS fallback)
```

### 2.2 Diagrama de Arquitetura

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   App do    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ   API       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  Firestore  ‚îÇ
‚îÇ   Gerente   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ  (Cloud Run)‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                    ‚îÇ   Gemini    ‚îÇ
                    ‚îÇ   (NLP)     ‚îÇ
                    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Funcion√°rio ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  WhatsApp   ‚îÇ
‚îÇ (WhatsApp)  ‚îÇ     ‚îÇ  Business   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 3. Modelo de Dados

### 3.1 Entidades

#### 3.1.1 Gerente (Manager)

```typescript
interface Manager {
  id: string;                    // UUID
  phone: string;                 // "+5511999999999" (√∫nico)
  name: string;                  // "Carlos Silva"
  email?: string;                // Opcional
  createdAt: Timestamp;
  updatedAt: Timestamp;

  // Auth
  phoneVerified: boolean;
  lastLoginAt?: Timestamp;

  // Push notifications
  fcmTokens: string[];           // Tokens de dispositivos
}
```

**√çndices:**
- `phone` (√∫nico)
- `createdAt`

#### 3.1.2 Estabelecimento (Establishment)

```typescript
interface Establishment {
  id: string;                    // UUID
  managerId: string;             // FK ‚Üí Manager
  name: string;                  // "Restaurante do Carlos"
  type: EstablishmentType;       // 'restaurant' | 'store' | 'bar' | 'other'

  // Hor√°rios de funcionamento
  operatingHours: {
    [day: number]: {             // 0=domingo, 1=segunda, ..., 6=s√°bado
      isOpen: boolean;
      openTime: string;          // "10:00" (HH:mm)
      closeTime: string;         // "22:00" (HH:mm)
    }
  };

  // Configura√ß√µes
  settings: {
    minEmployeesPerShift: number;        // M√≠nimo de pessoas por turno
    swapsAllowed: boolean;               // Trocas permitidas?
    swapsRequireApproval: boolean;       // Trocas requerem aprova√ß√£o?
    maxSwapsPerMonth: number;            // Limite de trocas por funcion√°rio (0 = ilimitado)
    restrictionDeadlineHours: number;    // Prazo para informar restri√ß√µes (default: 72)
    reminderBeforeDeadlineHours: number; // Lembrete X horas antes do prazo (default: 24)
  };

  // Status
  status: 'onboarding' | 'active' | 'inactive';
  onboardingStep: number;        // 1-7 durante onboarding

  createdAt: Timestamp;
  updatedAt: Timestamp;
}

type EstablishmentType = 'restaurant' | 'store' | 'bar' | 'other';
```

**√çndices:**
- `managerId`
- `status`
- `createdAt`

#### 3.1.3 Funcion√°rio (Employee)

```typescript
interface Employee {
  id: string;                    // UUID
  establishmentId: string;       // FK ‚Üí Establishment

  // Dados b√°sicos
  name: string;                  // "Jo√£o Silva"
  phone: string;                 // "+5511999991111"

  // Status no sistema
  status: EmployeeStatus;
  inviteSentAt?: Timestamp;      // Quando o convite foi enviado
  inviteRespondedAt?: Timestamp; // Quando respondeu

  // Restri√ß√µes de disponibilidade
  restrictions: Restriction[];

  // Contagem de trocas
  swapsUsedThisMonth: number;
  swapsResetAt: Timestamp;       // Primeiro dia do m√™s

  createdAt: Timestamp;
  updatedAt: Timestamp;
}

type EmployeeStatus =
  | 'pending_invite'             // Convite n√£o enviado ainda
  | 'invite_sent'                // Convite enviado, aguardando resposta
  | 'active'                     // Respondeu ou prazo expirou (dispon√≠vel)
  | 'inactive';                  // Desativado

interface Restriction {
  id: string;                    // UUID
  type: 'full_day' | 'time_range';
  dayOfWeek: number;             // 0-6 (domingo-s√°bado)
  startTime?: string;            // "18:00" - s√≥ para time_range
  endTime?: string;              // "23:59" - s√≥ para time_range
  reason?: string;               // "Faculdade"
  status: 'pending' | 'approved' | 'rejected';
  createdAt: Timestamp;
  reviewedAt?: Timestamp;
  reviewedBy?: string;           // managerId
}
```

**√çndices:**
- `establishmentId`
- `phone`
- `status`
- `establishmentId, status` (composto)

#### 3.1.4 Escala (Schedule)

```typescript
interface Schedule {
  id: string;                    // UUID
  establishmentId: string;       // FK ‚Üí Establishment

  // Per√≠odo
  weekStartDate: string;         // "2025-01-06" (sempre segunda-feira)
  weekEndDate: string;           // "2025-01-12" (sempre domingo)

  // Status
  status: ScheduleStatus;

  // Hist√≥rico
  createdAt: Timestamp;
  publishedAt?: Timestamp;
  updatedAt: Timestamp;

  // Vers√£o (para conflitos)
  version: number;
}

type ScheduleStatus =
  | 'collecting_restrictions'    // Coletando restri√ß√µes dos funcion√°rios
  | 'draft'                      // Gerada, aguardando revis√£o
  | 'published'                  // Publicada e ativa
  | 'archived';                  // Semana passou
```

**√çndices:**
- `establishmentId`
- `weekStartDate`
- `status`
- `establishmentId, weekStartDate` (composto, √∫nico)

#### 3.1.5 Turno (Shift)

```typescript
interface Shift {
  id: string;                    // UUID
  scheduleId: string;            // FK ‚Üí Schedule
  employeeId: string;            // FK ‚Üí Employee

  // Quando
  date: string;                  // "2025-01-06" (YYYY-MM-DD)
  startTime: string;             // "10:00" (HH:mm)
  endTime: string;               // "18:00" (HH:mm)

  // Status
  status: ShiftStatus;

  // Metadados
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

type ShiftStatus =
  | 'scheduled'                  // Normal
  | 'swap_pending'               // Troca em andamento
  | 'absent'                     // Funcion√°rio faltou
  | 'covered';                   // Foi coberto por outro
```

**√çndices:**
- `scheduleId`
- `employeeId`
- `date`
- `scheduleId, date` (composto)
- `employeeId, date` (composto)

#### 3.1.6 Troca (SwapRequest)

```typescript
interface SwapRequest {
  id: string;                    // UUID
  scheduleId: string;            // FK ‚Üí Schedule
  shiftId: string;               // FK ‚Üí Shift (turno original)

  // Quem
  requesterId: string;           // FK ‚Üí Employee (quem pediu)
  coverId?: string;              // FK ‚Üí Employee (quem vai cobrir)

  // Detalhes
  date: string;                  // "2025-01-06"
  reason?: string;               // "Consulta m√©dica"

  // Status
  status: SwapStatus;

  // Fluxo
  requestedAt: Timestamp;
  coverAcceptedAt?: Timestamp;
  managerReviewedAt?: Timestamp;
  resolvedAt?: Timestamp;

  // Resultado
  resolution?: 'approved' | 'rejected' | 'cancelled' | 'expired';
  resolutionNote?: string;
}

type SwapStatus =
  | 'finding_cover'              // Procurando quem cubra
  | 'pending_cover_response'     // Aguardando resposta do colega
  | 'pending_manager_approval'   // Aguardando aprova√ß√£o do gerente
  | 'approved'                   // Aprovada
  | 'rejected'                   // Rejeitada
  | 'cancelled'                  // Cancelada pelo solicitante
  | 'expired';                   // Expirou sem resolu√ß√£o
```

**√çndices:**
- `scheduleId`
- `requesterId`
- `coverId`
- `status`
- `date`

#### 3.1.7 Mensagem WhatsApp (WhatsAppMessage)

```typescript
interface WhatsAppMessage {
  id: string;                    // UUID

  // Participantes
  phone: string;                 // "+5511999991111"
  direction: 'inbound' | 'outbound';

  // Conte√∫do
  type: 'text' | 'button_response' | 'template';
  content: string;               // Texto da mensagem
  templateName?: string;         // Nome do template usado
  buttonPayload?: string;        // Payload do bot√£o clicado

  // Contexto
  context: MessageContext;

  // Status (para outbound)
  status?: 'pending' | 'sent' | 'delivered' | 'read' | 'failed';
  whatsappMessageId?: string;    // ID do WhatsApp

  // Processamento
  processedAt?: Timestamp;
  processedResult?: any;         // Resultado do processamento

  createdAt: Timestamp;
}

interface MessageContext {
  employeeId?: string;
  establishmentId?: string;
  scheduleId?: string;
  swapRequestId?: string;
  conversationState?: string;    // Estado da conversa
}
```

**√çndices:**
- `phone`
- `createdAt`
- `status`
- `phone, createdAt` (composto)

---

## 4. API Endpoints

### 4.1 Autentica√ß√£o

#### POST /auth/request-code
Solicita c√≥digo de verifica√ß√£o via SMS.

**Request:**
```json
{
  "phone": "+5511999999999"
}
```

**Response (200):**
```json
{
  "success": true,
  "expiresIn": 300
}
```

**Errors:**
- 400: N√∫mero inv√°lido
- 429: Muitas tentativas (rate limit)

---

#### POST /auth/verify-code
Verifica c√≥digo e retorna token.

**Request:**
```json
{
  "phone": "+5511999999999",
  "code": "123456"
}
```

**Response (200):**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIs...",
  "manager": {
    "id": "uuid",
    "phone": "+5511999999999",
    "name": "Carlos",
    "isNew": true
  },
  "establishment": null
}
```

**Errors:**
- 400: C√≥digo inv√°lido
- 410: C√≥digo expirado

---

### 4.2 Onboarding

#### POST /establishments
Cria estabelecimento (passo 2 do onboarding).

**Request:**
```json
{
  "name": "Restaurante do Carlos",
  "type": "restaurant"
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "name": "Restaurante do Carlos",
  "type": "restaurant",
  "status": "onboarding",
  "onboardingStep": 3
}
```

---

#### PATCH /establishments/:id/operating-hours
Define hor√°rios de funcionamento (passo 3).

**Request:**
```json
{
  "operatingHours": {
    "0": { "isOpen": false },
    "1": { "isOpen": true, "openTime": "10:00", "closeTime": "22:00" },
    "2": { "isOpen": true, "openTime": "10:00", "closeTime": "22:00" },
    "3": { "isOpen": true, "openTime": "10:00", "closeTime": "22:00" },
    "4": { "isOpen": true, "openTime": "10:00", "closeTime": "22:00" },
    "5": { "isOpen": true, "openTime": "10:00", "closeTime": "23:00" },
    "6": { "isOpen": true, "openTime": "10:00", "closeTime": "23:00" }
  }
}
```

**Response (200):**
```json
{
  "id": "uuid",
  "operatingHours": { ... },
  "onboardingStep": 4
}
```

---

#### PATCH /establishments/:id/settings
Define configura√ß√µes (passos 4 e 5).

**Request:**
```json
{
  "settings": {
    "minEmployeesPerShift": 3,
    "swapsAllowed": true,
    "swapsRequireApproval": true,
    "maxSwapsPerMonth": 2
  }
}
```

**Response (200):**
```json
{
  "id": "uuid",
  "settings": { ... },
  "onboardingStep": 6
}
```

---

### 4.3 Funcion√°rios

#### POST /establishments/:id/employees
Adiciona funcion√°rio(s).

**Request:**
```json
{
  "employees": [
    { "name": "Jo√£o Silva", "phone": "+5511999991111" },
    { "name": "Maria Santos", "phone": "+5511999992222" }
  ]
}
```

**Response (201):**
```json
{
  "employees": [
    { "id": "uuid1", "name": "Jo√£o Silva", "phone": "+5511999991111", "status": "pending_invite" },
    { "id": "uuid2", "name": "Maria Santos", "phone": "+5511999992222", "status": "pending_invite" }
  ]
}
```

**Errors:**
- 400: Telefone duplicado
- 400: Dados inv√°lidos

---

#### POST /establishments/:id/employees/send-invites
Envia convites para funcion√°rios.

**Request:**
```json
{
  "employeeIds": ["uuid1", "uuid2"]
}
```

**Response (200):**
```json
{
  "sent": 2,
  "failed": 0,
  "results": [
    { "employeeId": "uuid1", "status": "sent" },
    { "employeeId": "uuid2", "status": "sent" }
  ]
}
```

---

#### GET /establishments/:id/employees
Lista funcion√°rios.

**Query params:**
- `status`: Filtrar por status

**Response (200):**
```json
{
  "employees": [
    {
      "id": "uuid1",
      "name": "Jo√£o Silva",
      "phone": "+5511999991111",
      "status": "active",
      "restrictions": [
        {
          "id": "r1",
          "type": "time_range",
          "dayOfWeek": 2,
          "startTime": "18:00",
          "endTime": "23:59",
          "reason": "Faculdade",
          "status": "approved"
        }
      ],
      "swapsUsedThisMonth": 1
    }
  ]
}
```

---

#### PATCH /employees/:id/restrictions/:restrictionId
Aprova ou rejeita restri√ß√£o.

**Request:**
```json
{
  "status": "approved"
}
```

**Response (200):**
```json
{
  "restriction": {
    "id": "r1",
    "status": "approved",
    "reviewedAt": "2025-01-02T10:30:00Z"
  }
}
```

---

### 4.4 Escalas

#### POST /establishments/:id/schedules
Cria nova escala para a semana.

**Request:**
```json
{
  "weekStartDate": "2025-01-06"
}
```

**Response (201):**
```json
{
  "id": "uuid",
  "weekStartDate": "2025-01-06",
  "weekEndDate": "2025-01-12",
  "status": "collecting_restrictions"
}
```

---

#### POST /schedules/:id/generate
Gera escala automaticamente com AI.

**Request:**
```json
{}
```

**Response (200):**
```json
{
  "schedule": {
    "id": "uuid",
    "status": "draft",
    "shifts": [
      {
        "id": "s1",
        "employeeId": "e1",
        "employeeName": "Jo√£o",
        "date": "2025-01-06",
        "startTime": "10:00",
        "endTime": "18:00"
      }
    ],
    "validation": {
      "isValid": true,
      "warnings": [],
      "errors": []
    }
  }
}
```

**Validation Errors Examples:**
```json
{
  "isValid": false,
  "errors": [
    {
      "type": "understaffed",
      "date": "2025-01-08",
      "message": "Quarta precisa de 3 pessoas, s√≥ tem 2 dispon√≠veis",
      "severity": "error"
    }
  ],
  "warnings": [
    {
      "type": "consecutive_days",
      "employeeId": "e1",
      "message": "Jo√£o vai trabalhar 6 dias seguidos",
      "severity": "warning"
    }
  ]
}
```

---

#### PATCH /schedules/:id/shifts
Atualiza turnos manualmente.

**Request:**
```json
{
  "changes": [
    {
      "action": "remove",
      "shiftId": "s1"
    },
    {
      "action": "add",
      "employeeId": "e2",
      "date": "2025-01-06",
      "startTime": "10:00",
      "endTime": "18:00"
    }
  ]
}
```

**Response (200):**
```json
{
  "shifts": [ ... ],
  "validation": { ... }
}
```

---

#### POST /schedules/:id/publish
Publica escala e notifica funcion√°rios.

**Request:**
```json
{}
```

**Response (200):**
```json
{
  "schedule": {
    "id": "uuid",
    "status": "published",
    "publishedAt": "2025-01-03T14:00:00Z"
  },
  "notifications": {
    "sent": 5,
    "failed": 0
  }
}
```

---

### 4.5 Trocas

#### GET /establishments/:id/swap-requests
Lista pedidos de troca pendentes.

**Query params:**
- `status`: Filtrar por status

**Response (200):**
```json
{
  "swapRequests": [
    {
      "id": "sr1",
      "requester": { "id": "e1", "name": "Jo√£o" },
      "cover": { "id": "e2", "name": "Maria" },
      "date": "2025-01-10",
      "shift": { "startTime": "14:00", "endTime": "22:00" },
      "reason": "Consulta m√©dica",
      "status": "pending_manager_approval",
      "requestedAt": "2025-01-08T10:00:00Z"
    }
  ]
}
```

---

#### PATCH /swap-requests/:id
Aprova ou rejeita troca.

**Request:**
```json
{
  "action": "approve"
}
```

**Response (200):**
```json
{
  "swapRequest": {
    "id": "sr1",
    "status": "approved",
    "resolvedAt": "2025-01-08T11:30:00Z"
  }
}
```

---

#### POST /schedules/:id/emergency
Registra aus√™ncia de emerg√™ncia.

**Request:**
```json
{
  "employeeId": "e1",
  "date": "2025-01-10",
  "reason": "Doente"
}
```

**Response (200):**
```json
{
  "absence": {
    "employeeId": "e1",
    "date": "2025-01-10"
  },
  "availableForCover": [
    { "id": "e2", "name": "Maria", "note": "Est√° de folga" },
    { "id": "e3", "name": "Pedro", "note": "Entra √†s 14h, pode vir antes" }
  ]
}
```

---

#### POST /schedules/:id/emergency/request-cover
Pede cobertura para emerg√™ncia.

**Request:**
```json
{
  "absentEmployeeId": "e1",
  "coverEmployeeId": "e2",
  "date": "2025-01-10"
}
```

**Response (200):**
```json
{
  "status": "request_sent",
  "message": "Pedido enviado para Maria via WhatsApp"
}
```

---

### 4.6 Webhooks WhatsApp

#### POST /webhooks/whatsapp
Recebe mensagens do WhatsApp.

**Request (from WhatsApp):**
```json
{
  "object": "whatsapp_business_account",
  "entry": [{
    "changes": [{
      "value": {
        "messages": [{
          "from": "5511999991111",
          "type": "text",
          "text": { "body": "N√£o posso trabalhar quarta" }
        }]
      }
    }]
  }]
}
```

**Response:** 200 OK

---

## 5. User Stories

### 5.1 √âpico: Onboarding do Gerente

#### US-001: Login com WhatsApp
**Como** gerente
**Quero** fazer login usando meu n√∫mero de WhatsApp
**Para** acessar o sistema sem criar senha

**Crit√©rios de Aceite:**
- [ ] Campo para digitar n√∫mero com m√°scara (XX) XXXXX-XXXX
- [ ] Valida√ß√£o de n√∫mero brasileiro (11 d√≠gitos)
- [ ] Envio de SMS com c√≥digo de 6 d√≠gitos
- [ ] C√≥digo expira em 5 minutos
- [ ] M√°ximo 3 tentativas de c√≥digo errado
- [ ] Rate limit: 3 SMS por hora por n√∫mero
- [ ] Se n√∫mero n√£o existe, cria conta automaticamente

**Depend√™ncias:** Nenhuma

**Prioridade:** P0 (Cr√≠tico)

---

#### US-002: Configurar Nome e Tipo do Estabelecimento
**Como** gerente
**Quero** informar o nome e tipo do meu neg√≥cio
**Para** personalizar o sistema

**Crit√©rios de Aceite:**
- [ ] Campo de texto para nome (3-100 caracteres)
- [ ] Sele√ß√£o de tipo: Restaurante, Loja, Bar, Outro
- [ ] Bot√£o continuar s√≥ ativo quando preenchido
- [ ] Persistir dados ao sair e voltar

**Depend√™ncias:** US-001

**Prioridade:** P0

---

#### US-003: Configurar Hor√°rios de Funcionamento
**Como** gerente
**Quero** definir os dias e hor√°rios que meu neg√≥cio abre
**Para** que o sistema gere escalas v√°lidas

**Crit√©rios de Aceite:**
- [ ] Toggle para cada dia da semana (seg-dom)
- [ ] Op√ß√£o "mesmo hor√°rio todos os dias" ou "diferente por dia"
- [ ] Time picker para hor√°rio de abertura e fechamento
- [ ] Valida√ß√£o: fechamento > abertura
- [ ] Suporte a fechamento ap√≥s meia-noite (ex: 18h-02h)
- [ ] Default: seg-s√°b, 10h-22h

**Depend√™ncias:** US-002

**Prioridade:** P0

---

#### US-004: Configurar Equipe M√≠nima
**Como** gerente
**Quero** definir quantas pessoas preciso por turno
**Para** que o sistema n√£o crie escalas insuficientes

**Crit√©rios de Aceite:**
- [ ] Stepper num√©rico (1-20)
- [ ] Default: 3
- [ ] Texto explicativo sobre o uso

**Depend√™ncias:** US-003

**Prioridade:** P0

---

#### US-005: Configurar Regras de Troca
**Como** gerente
**Quero** definir se e como funcion√°rios podem trocar turnos
**Para** controlar a flexibilidade da escala

**Crit√©rios de Aceite:**
- [ ] Op√ß√£o 1: Sim, com minha aprova√ß√£o (default)
- [ ] Op√ß√£o 2: Sim, sem precisar aprovar
- [ ] Op√ß√£o 3: N√£o permitir trocas
- [ ] Se trocas permitidas: stepper para limite mensal (0-10, 0=ilimitado)
- [ ] Default: 2 trocas/m√™s

**Depend√™ncias:** US-004

**Prioridade:** P0

---

#### US-006: Adicionar Funcion√°rios Manualmente
**Como** gerente
**Quero** cadastrar meus funcion√°rios com nome e WhatsApp
**Para** que eles recebam a escala

**Crit√©rios de Aceite:**
- [ ] Campos: Nome (obrigat√≥rio), WhatsApp (obrigat√≥rio)
- [ ] M√°scara de telefone brasileiro
- [ ] Valida√ß√£o de n√∫mero duplicado
- [ ] Bot√£o "+ Adicionar mais"
- [ ] Lista mostrando funcion√°rios adicionados
- [ ] Op√ß√£o de remover antes de confirmar
- [ ] M√≠nimo 2 funcion√°rios para continuar

**Depend√™ncias:** US-005

**Prioridade:** P0

---

#### US-007: Enviar Convites para Equipe
**Como** gerente
**Quero** enviar convites para meus funcion√°rios via WhatsApp
**Para** que eles informem suas restri√ß√µes

**Crit√©rios de Aceite:**
- [ ] Bot√£o "Enviar Convites"
- [ ] Confirma√ß√£o antes de enviar
- [ ] Loading durante envio
- [ ] Feedback de sucesso/erro por funcion√°rio
- [ ] Mensagem do convite conforme template aprovado
- [ ] Marcar estabelecimento como "active" ap√≥s envio

**Depend√™ncias:** US-006

**Prioridade:** P0

---

### 5.2 √âpico: Coleta de Restri√ß√µes

#### US-008: Receber Convite (Funcion√°rio)
**Como** funcion√°rio
**Quero** receber uma mensagem perguntando minha disponibilidade
**Para** informar quando n√£o posso trabalhar

**Crit√©rios de Aceite:**
- [ ] Mensagem personalizada com nome do funcion√°rio e estabelecimento
- [ ] Exemplos de como responder
- [ ] Mensagem chega via WhatsApp Business API
- [ ] Registro de envio no sistema

**Depend√™ncias:** US-007

**Prioridade:** P0

---

#### US-009: Informar Restri√ß√µes (Funcion√°rio)
**Como** funcion√°rio
**Quero** responder com meus hor√°rios indispon√≠veis
**Para** que sejam considerados na escala

**Crit√©rios de Aceite:**
- [ ] Aceitar texto livre em portugu√™s
- [ ] Gemini interpreta e extrai restri√ß√µes
- [ ] Sistema confirma entendimento: "Entendi: Ter√ßa e Quinta depois das 18h"
- [ ] Bot√µes [Sim] [Corrigir] para confirmar
- [ ] Se corrigir, pede para reformular
- [ ] Ap√≥s confirma√ß√£o, atualiza status para "active"

**Exemplos de input:**
- "Quarta n√£o posso" ‚Üí full_day, dayOfWeek=3
- "Ter√ßa e quinta depois das 18h" ‚Üí time_range, days=[2,4], start=18:00
- "Posso qualquer hor√°rio" ‚Üí sem restri√ß√µes
- "Domingo nunca" ‚Üí full_day, dayOfWeek=0

**Depend√™ncias:** US-008

**Prioridade:** P0

---

#### US-010: Lembrete de Restri√ß√µes
**Como** sistema
**Quero** enviar lembrete para quem n√£o respondeu
**Para** maximizar taxa de resposta

**Crit√©rios de Aceite:**
- [ ] Lembrete 24h antes do prazo (configur√°vel)
- [ ] Lembrete final no prazo
- [ ] Ap√≥s prazo, marca como "dispon√≠vel" automaticamente
- [ ] Notifica gerente sobre quem n√£o respondeu

**Depend√™ncias:** US-009

**Prioridade:** P1

---

#### US-011: Aprovar/Rejeitar Restri√ß√µes (Gerente)
**Como** gerente
**Quero** ver e aprovar as restri√ß√µes dos funcion√°rios
**Para** validar antes de gerar a escala

**Crit√©rios de Aceite:**
- [ ] Tela listando todos funcion√°rios
- [ ] Status: ‚úÖ Dispon√≠vel, ‚è≥ Aguardando, ‚ö†Ô∏è Pendente
- [ ] Para pendentes: mostrar restri√ß√£o e motivo
- [ ] Bot√µes [Aprovar] [Recusar]
- [ ] Se recusar, funcion√°rio √© notificado
- [ ] Bot√£o "Gerar Escala" quando todos processados ou prazo expirou

**Depend√™ncias:** US-009

**Prioridade:** P0

---

### 5.3 √âpico: Gera√ß√£o de Escala

#### US-012: Gerar Escala Automaticamente
**Como** gerente
**Quero** que o sistema crie a escala automaticamente
**Para** n√£o ter que fazer manualmente

**Crit√©rios de Aceite:**
- [ ] Considera hor√°rios de funcionamento
- [ ] Respeita restri√ß√µes aprovadas
- [ ] Garante m√≠nimo de pessoas por turno
- [ ] Garante 1 folga semanal por funcion√°rio (CLT)
- [ ] Distribui turnos de forma justa
- [ ] Evita mais de 6 dias consecutivos
- [ ] Mostra grid com escala gerada
- [ ] Mostra valida√ß√µes (erros e avisos)

**Algoritmo:**
1. Listar todos os dias que o estabelecimento abre
2. Para cada dia, calcular funcion√°rios dispon√≠veis
3. Distribuir considerando:
   - Restri√ß√µes individuais
   - Hist√≥rico de turnos (justi√ßa)
   - Proximidade de folga anterior
4. Validar resultado

**Depend√™ncias:** US-011

**Prioridade:** P0

---

#### US-013: Ajustar Escala Manualmente
**Como** gerente
**Quero** fazer ajustes na escala gerada
**Para** resolver casos especiais

**Crit√©rios de Aceite:**
- [ ] Toque em c√©lula da grid para editar
- [ ] Op√ß√µes: Dar folga, Escalar, Trocar
- [ ] Valida√ß√£o em tempo real (mostra se ficou inv√°lido)
- [ ] Sugest√µes de quem pode cobrir
- [ ] Hist√≥rico de altera√ß√µes na sess√£o (undo)

**Depend√™ncias:** US-012

**Prioridade:** P0

---

#### US-014: Resolver Conflitos
**Como** gerente
**Quero** ver e resolver conflitos de disponibilidade
**Para** completar a escala

**Crit√©rios de Aceite:**
- [ ] Destacar dias com problema (menos gente que o m√≠nimo)
- [ ] Mostrar quem pediu folga e motivos
- [ ] Permitir selecionar quem vai trabalhar mesmo assim
- [ ] Notificar funcion√°rio que teve folga negada

**Depend√™ncias:** US-012

**Prioridade:** P0

---

#### US-015: Publicar Escala
**Como** gerente
**Quero** publicar a escala para a equipe
**Para** que todos saibam quando trabalham

**Crit√©rios de Aceite:**
- [ ] Bot√£o "Publicar Escala"
- [ ] Confirma√ß√£o com resumo
- [ ] Enviar mensagem individual para cada funcion√°rio
- [ ] Mensagem mostra apenas turnos daquele funcion√°rio
- [ ] Incluir link para ver escala completa
- [ ] Atualizar status para "published"
- [ ] Feedback de envio (X enviados, Y falhas)

**Depend√™ncias:** US-013

**Prioridade:** P0

---

### 5.4 √âpico: Trocas de Turno

#### US-016: Solicitar Troca (Funcion√°rio)
**Como** funcion√°rio
**Quero** pedir para trocar um turno
**Para** resolver um imprevisto

**Crit√©rios de Aceite:**
- [ ] Funcion√°rio envia mensagem "n√£o posso sexta"
- [ ] Sistema identifica turno e oferece op√ß√µes
- [ ] Mostra quem est√° de folga naquele dia
- [ ] Bot√µes para pedir cobertura ou falar com gerente
- [ ] Verificar limite de trocas
- [ ] Se limite atingido, oferecer pedir exce√ß√£o

**Depend√™ncias:** US-015

**Prioridade:** P0

---

#### US-017: Aceitar Cobertura (Funcion√°rio)
**Como** funcion√°rio
**Quero** aceitar cobrir o turno de um colega
**Para** ajudar a equipe

**Crit√©rios de Aceite:**
- [ ] Receber mensagem com pedido de cobertura
- [ ] Mostrar detalhes (quem, quando, hor√°rio)
- [ ] Bot√µes [Sim, posso] [N√£o posso]
- [ ] Se aceitar, notificar pr√≥ximo passo (aprova√ß√£o do gerente ou autom√°tico)
- [ ] Se recusar, notificar solicitante

**Depend√™ncias:** US-016

**Prioridade:** P0

---

#### US-018: Aprovar Troca (Gerente)
**Como** gerente
**Quero** aprovar ou rejeitar trocas solicitadas
**Para** manter controle da escala

**Crit√©rios de Aceite:**
- [ ] Notifica√ß√£o push quando h√° troca pendente
- [ ] Card na home com trocas pendentes
- [ ] Mostrar: quem pediu, quem cobre, quando, motivo
- [ ] Bot√µes [Aprovar] [Rejeitar]
- [ ] Se aprovar, atualizar escala automaticamente
- [ ] Notificar ambos funcion√°rios do resultado

**Depend√™ncias:** US-017

**Prioridade:** P0

---

#### US-019: Notificar Escala Atualizada
**Como** sistema
**Quero** avisar todos sobre mudan√ßas na escala
**Para** que ningu√©m fique desatualizado

**Crit√©rios de Aceite:**
- [ ] Ap√≥s troca aprovada, enviar resumo da mudan√ßa
- [ ] Mostrar o que mudou (antes ‚Üí depois)
- [ ] Enviar para todos os funcion√°rios afetados no dia

**Depend√™ncias:** US-018

**Prioridade:** P1

---

### 5.5 √âpico: Emerg√™ncias

#### US-020: Registrar Aus√™ncia de Emerg√™ncia
**Como** gerente
**Quero** registrar que algu√©m faltou de √∫ltima hora
**Para** encontrar cobertura rapidamente

**Crit√©rios de Aceite:**
- [ ] Bot√£o "Algu√©m Faltou" na home
- [ ] Listar funcion√°rios escalados hoje
- [ ] Selecionar quem faltou
- [ ] Mostrar op√ß√µes de cobertura:
  - Quem est√° de folga
  - Quem pode fazer hora extra
- [ ] Ordenar por "probabilidade" (folga > hora extra)

**Depend√™ncias:** US-015

**Prioridade:** P0

---

#### US-021: Pedir Cobertura de Emerg√™ncia
**Como** gerente
**Quero** pedir para algu√©m cobrir uma emerg√™ncia
**Para** n√£o ficar desfalcado

**Crit√©rios de Aceite:**
- [ ] Selecionar quem pedir
- [ ] Enviar mensagem urgente via WhatsApp
- [ ] Mensagem marcada como urgente (emoji üÜò)
- [ ] Aguardar resposta
- [ ] Se aceitar, atualizar escala imediatamente
- [ ] Notificar gerente do resultado

**Depend√™ncias:** US-020

**Prioridade:** P0

---

### 5.6 √âpico: Visualiza√ß√£o

#### US-022: Tela Home do Gerente
**Como** gerente
**Quero** ver um resumo do dia e pend√™ncias
**Para** ter vis√£o r√°pida da situa√ß√£o

**Crit√©rios de Aceite:**
- [ ] Mostrar "Hoje" com data
- [ ] Listar quem trabalha hoje e hor√°rios
- [ ] Bot√£o "Algu√©m Faltou" destacado
- [ ] Se√ß√£o de pend√™ncias (trocas, restri√ß√µes)
- [ ] Resumo da semana (calend√°rio compacto)
- [ ] Bottom nav: Escala, Equipe, Config

**Depend√™ncias:** US-015

**Prioridade:** P0

---

#### US-023: Ver Escala Semanal
**Como** gerente
**Quero** ver a escala completa da semana
**Para** ter vis√£o geral

**Crit√©rios de Aceite:**
- [ ] Grid: dias (colunas) x funcion√°rios (linhas)
- [ ] Indicador visual: trabalha/folga
- [ ] Navegar entre semanas
- [ ] Toque para editar (se rascunho)
- [ ] Mostrar contagem por dia

**Depend√™ncias:** US-015

**Prioridade:** P1

---

#### US-024: Ver Escala Individual (Funcion√°rio)
**Como** funcion√°rio
**Quero** ver minha escala quando quiser
**Para** confirmar meus hor√°rios

**Crit√©rios de Aceite:**
- [ ] Enviar "qual minha escala" no WhatsApp
- [ ] Sistema responde com escala da semana atual
- [ ] Incluir link para p√°gina web com escala

**Depend√™ncias:** US-015

**Prioridade:** P1

---

## 6. Fluxos de Conversa WhatsApp

### 6.1 Convite Inicial

```
TRIGGER: Gerente clica "Enviar Convites"

BOT ‚Üí FUNCION√ÅRIO:
"Oi {nome}! üëã

Seu gerente {nomeGerente} cadastrou voc√™ no Escala Simples
do {nomeEstabelecimento}.

Agora voc√™ vai receber sua escala por aqui e pode
pedir trocas de turno quando precisar.

Pra come√ßar, me conta:
Tem algum dia/hor√°rio fixo que voc√™ N√ÉO PODE trabalhar?

Exemplos:
‚Ä¢ "Quarta de manh√£ tenho faculdade"
‚Ä¢ "Domingo n√£o posso"
‚Ä¢ "Posso qualquer hor√°rio"

Responde a√≠ üëá"

STATE: awaiting_restrictions
```

### 6.2 Processamento de Restri√ß√µes

```
TRIGGER: Mensagem recebida em STATE: awaiting_restrictions

1. Enviar texto para Gemini com prompt:
   "Extraia restri√ß√µes de disponibilidade desta mensagem.
    Retorne JSON com: [{dayOfWeek, type, startTime?, endTime?}]
    dayOfWeek: 0=domingo, 1=segunda...
    type: 'full_day' ou 'time_range'"

2. Se Gemini retornar restri√ß√µes:

BOT ‚Üí FUNCION√ÅRIO:
"Entendi! ‚úì

Suas restri√ß√µes:
‚Ä¢ {lista formatada}

T√° certo isso?"

BUTTONS: [Sim] [Corrigir]
STATE: confirming_restrictions

3. Se Gemini n√£o conseguir extrair:

BOT ‚Üí FUNCION√ÅRIO:
"N√£o entendi bem üòÖ

Pode reformular? Por exemplo:
‚Ä¢ 'Segunda n√£o posso'
‚Ä¢ 'Ter√ßa e quinta depois das 19h'
‚Ä¢ 'Posso qualquer hor√°rio'"

STATE: awaiting_restrictions (mant√©m)
```

### 6.3 Escala Publicada

```
TRIGGER: Gerente publica escala

BOT ‚Üí FUNCION√ÅRIO:
"üìÖ Escala - {nomeEstabelecimento}
Semana {dataInicio} - {dataFim}

Sua escala, {nome}:

{para cada dia}
{emoji} {diaSemana} {data}: {status}
{/para cada dia}

Precisa trocar algum dia? Responde aqui."

Onde:
- emoji: ‚úÖ se trabalha, ‚ùå se folga
- status: hor√°rio se trabalha, "Folga" ou "Fechado"
```

### 6.4 Pedido de Troca

```
TRIGGER: Funcion√°rio envia algo como "n√£o posso {dia}"

1. Identificar dia mencionado
2. Verificar se est√° escalado nesse dia
3. Verificar limite de trocas

BOT ‚Üí FUNCION√ÅRIO:
"Entendi. {dia} voc√™ est√° escalado {hor√°rio}.

Voc√™ ainda tem {X} trocas dispon√≠veis este m√™s.

Quem est√° de folga {dia}:
‚Ä¢ {nome1}
‚Ä¢ {nome2}

Quer pedir para algu√©m cobrir?"

BUTTONS: [Pedir {nome1}] [Pedir {nome2}] [Falar com gerente]
STATE: requesting_swap
```

### 6.5 Pedido de Cobertura

```
TRIGGER: Funcion√°rio A pediu troca, funcion√°rio B selecionado

BOT ‚Üí FUNCION√ÅRIO B:
"Oi {nome}! üëã

{nomeA} n√£o pode trabalhar {dia} ({hor√°rio}).
Voc√™ pode cobrir?

[Sim, posso] [N√£o posso]"

STATE: awaiting_cover_response
```

### 6.6 Cobertura de Emerg√™ncia

```
TRIGGER: Gerente solicita cobertura de emerg√™ncia

BOT ‚Üí FUNCION√ÅRIO:
"üÜò URGENTE

{nomeAusente} n√£o pode trabalhar hoje.
Voc√™ pode cobrir {hor√°rio}?

{nomeGerente} est√° pedindo.

[Sim] [N√£o posso]"

STATE: awaiting_emergency_response
```

---

## 7. Regras de Neg√≥cio

### 7.1 Valida√ß√µes de Escala

| Regra | Tipo | Descri√ß√£o |
|-------|------|-----------|
| MIN_EMPLOYEES | Error | M√≠nimo de funcion√°rios por turno |
| WEEKLY_REST | Error | M√≠nimo 1 folga semanal (CLT) |
| MAX_CONSECUTIVE | Warning | M√°ximo 6 dias consecutivos |
| RESTRICTION_CONFLICT | Error | Funcion√°rio escalado em hor√°rio restrito |
| INTER_SHIFT_REST | Warning | M√≠nimo 11h entre turnos (CLT) |

### 7.2 Limites do Sistema

| Par√¢metro | Limite | Justificativa |
|-----------|--------|---------------|
| Funcion√°rios por estabelecimento | 50 | Performance |
| Estabelecimentos por gerente | 1 (MVP) | Simplicidade |
| Trocas por m√™s por funcion√°rio | 0-10 (config) | Controle |
| Prazo para restri√ß√µes | 72h (config) | Tempo de processamento |
| Reenvio de convite | 1x por dia | Anti-spam |

### 7.3 Timeouts

| Evento | Timeout | A√ß√£o |
|--------|---------|------|
| C√≥digo SMS | 5 min | Expirar, pedir novo |
| Resposta de restri√ß√£o | 72h | Assumir dispon√≠vel |
| Resposta de cobertura | 2h | Notificar solicitante |
| Resposta de emerg√™ncia | 30 min | Sugerir pr√≥ximo |
| Aprova√ß√£o de troca (gerente) | 24h | Notificar pendente |

---

## 8. Componentes de UI

### 8.1 App do Gerente

#### Telas

| Tela | Descri√ß√£o | Componentes Principais |
|------|-----------|------------------------|
| Login | Entrada do n√∫mero | PhoneInput, Button |
| VerifyCode | Digitar c√≥digo | CodeInput (6 digits), Timer |
| Onboarding/Name | Nome e tipo | TextInput, SegmentedControl |
| Onboarding/Hours | Hor√°rios | DayToggle[], TimePicker |
| Onboarding/MinEmployees | M√≠nimo | Stepper |
| Onboarding/Swaps | Regras troca | RadioGroup, Stepper |
| Onboarding/Team | Adicionar equipe | EmployeeList, AddEmployeeModal |
| Onboarding/Invite | Enviar convites | Button, ProgressIndicator |
| Home | Dashboard | TodayCard, PendingList, WeekPreview |
| Schedule | Escala semanal | ScheduleGrid, DayColumn, ShiftCell |
| Team | Lista funcion√°rios | EmployeeCard[], StatusBadge |
| Settings | Configura√ß√µes | SettingRow[] |
| Restrictions | Aprovar restri√ß√µes | RestrictionCard[], ApproveButton |
| Emergency | Aus√™ncia emerg√™ncia | EmployeeSelector, CoverOptions |

#### Componentes Reutiliz√°veis

| Componente | Props | Descri√ß√£o |
|------------|-------|-----------|
| PhoneInput | value, onChange, country | Input com m√°scara |
| CodeInput | length, onComplete | Input de c√≥digo |
| Button | variant, loading, disabled | Bot√£o prim√°rio/secund√°rio |
| Stepper | value, min, max, onChange | Incremento/decremento |
| TimePicker | value, onChange | Seletor de hora |
| DayToggle | day, selected, onChange | Toggle de dia |
| EmployeeCard | employee, onPress | Card de funcion√°rio |
| StatusBadge | status | Badge colorido |
| ShiftCell | shift, onPress | C√©lula da escala |
| PendingCard | item, onApprove, onReject | Card de pend√™ncia |

### 8.2 Estados de Loading

| A√ß√£o | Tipo | Feedback |
|------|------|----------|
| Login | Full screen | Spinner + "Enviando c√≥digo..." |
| Verificar c√≥digo | Button | Button loading |
| Salvar configura√ß√£o | Button | Button loading |
| Enviar convites | Full screen | Progress + contagem |
| Gerar escala | Full screen | Spinner + "Gerando escala..." |
| Publicar escala | Full screen | Progress + contagem |
| Aprovar/Rejeitar | Button | Button loading |

### 8.3 Estados de Erro

| Erro | Mensagem | A√ß√£o |
|------|----------|------|
| N√∫mero inv√°lido | "N√∫mero inv√°lido. Confira e tente novamente." | Destacar campo |
| C√≥digo errado | "C√≥digo incorreto. Tente novamente." | Limpar campo |
| C√≥digo expirado | "C√≥digo expirado. Solicite um novo." | Bot√£o reenviar |
| Sem conex√£o | "Sem internet. Verifique sua conex√£o." | Bot√£o tentar novamente |
| Erro servidor | "Algo deu errado. Tente novamente." | Bot√£o tentar novamente |
| WhatsApp falhou | "N√£o foi poss√≠vel enviar para X." | Retry individual |

---

## 9. Fases de Desenvolvimento

### Fase 1: Funda√ß√£o (Semanas 1-2)

**Objetivo:** Setup t√©cnico e autentica√ß√£o

| Task | Descri√ß√£o | Estimativa |
|------|-----------|------------|
| Setup projeto React Native + Expo | Criar projeto, configurar navega√ß√£o | 4h |
| Setup GCP (Cloud Run, Firestore) | Infraestrutura backend | 4h |
| Implementar autentica√ß√£o SMS | Envio de c√≥digo, verifica√ß√£o | 8h |
| Telas de login e c√≥digo | UI de autentica√ß√£o | 6h |
| Modelo de dados base | Firestore schemas | 4h |
| API de autentica√ß√£o | Endpoints auth/* | 6h |

**Entreg√°vel:** Login funcional com SMS

---

### Fase 2: Onboarding (Semanas 3-4)

**Objetivo:** Fluxo completo de configura√ß√£o

| Task | Descri√ß√£o | Estimativa |
|------|-----------|------------|
| Tela nome/tipo estabelecimento | UI + API | 4h |
| Tela hor√°rios funcionamento | UI complexa + API | 8h |
| Tela equipe m√≠nima | UI + API | 3h |
| Tela regras de troca | UI + API | 4h |
| Tela adicionar funcion√°rios | Lista + modal + API | 8h |
| Tela enviar convites | UI + integra√ß√£o WhatsApp | 6h |
| Persist√™ncia de estado | Voltar onde parou | 4h |

**Entreg√°vel:** Onboarding completo funcionando

---

### Fase 3: WhatsApp Integration (Semanas 5-6)

**Objetivo:** Comunica√ß√£o bidirecional com funcion√°rios

| Task | Descri√ß√£o | Estimativa |
|------|-----------|------------|
| Setup WhatsApp Business API | Configura√ß√£o Meta | 4h |
| Webhook de recebimento | Cloud Function | 6h |
| Templates de mensagem | Aprova√ß√£o Meta | 4h |
| Envio de mensagens | Service de envio | 6h |
| Integra√ß√£o com Gemini | Processamento NLP | 8h |
| Fluxo de restri√ß√µes | Conversa completa | 8h |
| Testes de conversa | Cen√°rios diversos | 6h |

**Entreg√°vel:** Funcion√°rios podem informar restri√ß√µes via WhatsApp

---

### Fase 4: Gera√ß√£o de Escala (Semanas 7-8)

**Objetivo:** Criar escalas automaticamente

| Task | Descri√ß√£o | Estimativa |
|------|-----------|------------|
| Tela de restri√ß√µes pendentes | UI gerente | 6h |
| Algoritmo de gera√ß√£o | L√≥gica de distribui√ß√£o | 12h |
| Valida√ß√µes CLT | Regras de neg√≥cio | 6h |
| Tela de escala gerada | Grid interativo | 10h |
| Edi√ß√£o manual de escala | Ajustes na grid | 8h |
| Resolu√ß√£o de conflitos | UI de conflitos | 6h |
| Publica√ß√£o de escala | Envio em massa | 6h |

**Entreg√°vel:** Gerente pode gerar e publicar escalas

---

### Fase 5: Trocas (Semanas 9-10)

**Objetivo:** Permitir trocas entre funcion√°rios

| Task | Descri√ß√£o | Estimativa |
|------|-----------|------------|
| Fluxo de solicita√ß√£o (WhatsApp) | Conversa de troca | 8h |
| Fluxo de aceite (WhatsApp) | Resposta do colega | 6h |
| Tela de aprova√ß√£o (Gerente) | Cards de pend√™ncias | 6h |
| Atualiza√ß√£o autom√°tica de escala | Ap√≥s aprova√ß√£o | 4h |
| Notifica√ß√£o de mudan√ßas | Broadcast WhatsApp | 4h |
| Limite de trocas | Controle mensal | 4h |
| Pedir exce√ß√£o | Fluxo extra | 4h |

**Entreg√°vel:** Sistema completo de trocas

---

### Fase 6: Emerg√™ncias e Polish (Semanas 11-12)

**Objetivo:** Fluxo de emerg√™ncia e refinamentos

| Task | Descri√ß√£o | Estimativa |
|------|-----------|------------|
| Tela de emerg√™ncia | "Algu√©m faltou" | 6h |
| Sugest√£o de cobertura | Algoritmo | 4h |
| Pedido urgente (WhatsApp) | Mensagem priorit√°ria | 4h |
| Home do gerente | Dashboard consolidado | 8h |
| Visualiza√ß√£o semanal | Tela de escala | 6h |
| Push notifications | Firebase Cloud Messaging | 6h |
| Testes E2E | Fluxos completos | 8h |
| Bug fixes e polish | Refinamentos | 16h |

**Entreg√°vel:** MVP completo e testado

---

## 10. M√©tricas de Sucesso

### 10.1 North Star Metric

> **Escalas publicadas por semana**

### 10.2 M√©tricas por Fase

| Fase | M√©trica | Meta |
|------|---------|------|
| Onboarding | Tempo de setup | < 10 min |
| Onboarding | Taxa de conclus√£o | > 70% |
| Restri√ß√µes | Taxa de resposta funcion√°rios | > 70% |
| Escala | Tempo para gerar | < 30 seg |
| Escala | Escalas publicadas D1 | > 50% |
| Trocas | Trocas resolvidas automaticamente | > 80% |
| Engajamento | Reten√ß√£o D7 | > 60% |
| Engajamento | Reten√ß√£o D30 | > 40% |

### 10.3 Eventos de Analytics

| Evento | Par√¢metros |
|--------|------------|
| onboarding_started | - |
| onboarding_step_completed | step_number, step_name |
| onboarding_completed | total_time_seconds |
| employee_added | count |
| invites_sent | count, success_count |
| restriction_received | employee_id |
| restriction_approved | employee_id |
| schedule_generated | employee_count, day_count |
| schedule_edited | edit_count |
| schedule_published | employee_count |
| swap_requested | requester_id |
| swap_accepted | cover_id |
| swap_approved | - |
| swap_rejected | - |
| emergency_started | - |
| emergency_resolved | time_to_resolve_minutes |

---

## 11. Considera√ß√µes de Seguran√ßa

### 11.1 Autentica√ß√£o

- C√≥digos SMS expiram em 5 minutos
- M√°ximo 3 tentativas de c√≥digo errado
- Rate limit: 3 SMS por hora por n√∫mero
- Tokens JWT com expira√ß√£o de 30 dias
- Refresh token rotation

### 11.2 Autoriza√ß√£o

- Gerente s√≥ acessa seu estabelecimento
- Funcion√°rio s√≥ v√™ pr√≥pria escala
- Validar ownership em todas as opera√ß√µes
- Audit log de a√ß√µes sens√≠veis

### 11.3 Dados

- N√∫meros de telefone com hash em logs
- Firestore security rules
- HTTPS obrigat√≥rio
- Backup di√°rio

---

## 12. Considera√ß√µes de Performance

### 12.1 Alvos

| Opera√ß√£o | Alvo |
|----------|------|
| Tempo de loading inicial | < 2s |
| Gera√ß√£o de escala | < 5s |
| Envio de mensagens (batch) | < 30s para 50 funcion√°rios |
| Response time API | < 200ms (p95) |

### 12.2 Otimiza√ß√µes

- Pagina√ß√£o de listas (20 items)
- Cache de dados frequentes
- Lazy loading de telas
- Compress√£o de imagens
- Debounce em buscas

---

## 13. Gloss√°rio

| Termo | Defini√ß√£o |
|-------|-----------|
| Estabelecimento | Restaurante, loja ou bar onde os funcion√°rios trabalham |
| Gerente | Usu√°rio que administra o estabelecimento (dono ou gerente) |
| Funcion√°rio | Pessoa que trabalha no estabelecimento (horista) |
| Restri√ß√£o | Hor√°rio/dia que funcion√°rio N√ÉO pode trabalhar |
| Escala | Distribui√ß√£o de turnos para uma semana |
| Turno | Per√≠odo de trabalho de um funcion√°rio em um dia |
| Troca | Substitui√ß√£o de um funcion√°rio por outro em um turno |
| Cobertura | Quando um funcion√°rio assume turno de outro |

---

*PRD - Escala Simples*
*Vers√£o 2.0 - 28/12/2024*
*Ready for Development*
