rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // HELPER FUNCTIONS
    // =========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Check if user is manager (owner) of establishment
    function isManagerOf(establishmentId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/establishments/$(establishmentId)) &&
        get(/databases/$(database)/documents/establishments/$(establishmentId)).data.ownerId == request.auth.uid;
    }

    // Check if user is an employee (authenticated via custom token with role)
    function isEmployee() {
      return isAuthenticated() && request.auth.token.role == 'employee';
    }

    // Check if user is a manager (not an employee)
    function isManager() {
      return isAuthenticated() && request.auth.token.role != 'employee';
    }

    // Check if employee has access to this establishment
    function isEmployeeOfEstablishment(establishmentId) {
      return isEmployee() && request.auth.token.phone != null;
      // Note: Full validation is done at API level since we need to query by phone
    }

    // =========================================================================
    // MANAGERS
    // =========================================================================

    match /managers/{managerId} {
      // Managers can read and update their own profile
      allow read, update: if isOwner(managerId);
      // Create on first auth
      allow create: if isAuthenticated() && request.auth.uid == managerId;
      // No delete allowed
      allow delete: if false;
    }

    // =========================================================================
    // ESTABLISHMENTS
    // =========================================================================

    match /establishments/{establishmentId} {
      // Manager can read their establishments
      allow read: if isAuthenticated() &&
        resource.data.ownerId == request.auth.uid;

      // Manager can create establishment
      allow create: if isAuthenticated() &&
        request.resource.data.ownerId == request.auth.uid;

      // Manager can update their establishment
      allow update: if isAuthenticated() &&
        resource.data.ownerId == request.auth.uid;

      // No delete allowed
      allow delete: if false;
    }

    // =========================================================================
    // EMPLOYEES
    // =========================================================================

    match /employees/{employeeId} {
      // Manager can read employees of their establishments
      // Employee can read only their own document (validated by API)
      allow read: if isManagerOf(resource.data.establishmentId) ||
        (isEmployee() && request.auth.token.phone != null);

      // Manager can create employees for their establishments
      allow create: if isManagerOf(request.resource.data.establishmentId);

      // Manager can update employees of their establishments
      // Employee can update only specific fields (availability)
      allow update: if isManagerOf(resource.data.establishmentId) ||
        (isEmployee() &&
          request.auth.token.phone != null &&
          // Only allow updating availability fields
          request.resource.data.diff(resource.data).affectedKeys().hasOnly(['recurringAvailability', 'temporaryAvailability', 'availabilityUpdatedAt']));

      // Manager can delete (deactivate) employees
      allow delete: if isManagerOf(resource.data.establishmentId);
    }

    // =========================================================================
    // SCHEDULES
    // =========================================================================

    match /schedules/{scheduleId} {
      // Manager can read schedules of their establishments
      // Employee can read published schedules of their establishments
      allow read: if isManagerOf(resource.data.establishmentId) ||
        (isEmployee() && resource.data.status == 'published');

      // Manager can create schedules for their establishments
      allow create: if isManagerOf(request.resource.data.establishmentId);

      // Manager can update schedules of their establishments
      allow update: if isManagerOf(resource.data.establishmentId);

      // Manager can delete draft schedules
      allow delete: if isManagerOf(resource.data.establishmentId) &&
        resource.data.status == 'draft';
    }

    // =========================================================================
    // SHIFTS (embedded in schedules, but kept for potential future separation)
    // =========================================================================

    match /shifts/{shiftId} {
      // Manager can read shifts via schedule
      allow read: if isAuthenticated() &&
        exists(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)) &&
        isManagerOf(get(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)).data.establishmentId);

      // Manager can create shifts
      allow create: if isAuthenticated() &&
        exists(/databases/$(database)/documents/schedules/$(request.resource.data.scheduleId)) &&
        isManagerOf(get(/databases/$(database)/documents/schedules/$(request.resource.data.scheduleId)).data.establishmentId);

      // Manager can update shifts
      allow update: if isAuthenticated() &&
        exists(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)) &&
        isManagerOf(get(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)).data.establishmentId);

      // No delete allowed
      allow delete: if false;
    }

    // =========================================================================
    // SWAP REQUESTS
    // =========================================================================

    match /swapRequests/{swapId} {
      // Manager can read swap requests via schedule
      allow read: if isAuthenticated() &&
        exists(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)) &&
        isManagerOf(get(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)).data.establishmentId);

      // Swap requests are created by Cloud Functions (from WhatsApp)
      // Manager can update (approve/reject)
      allow update: if isAuthenticated() &&
        exists(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)) &&
        isManagerOf(get(/databases/$(database)/documents/schedules/$(resource.data.scheduleId)).data.establishmentId);

      // No direct create/delete from client
      allow create, delete: if false;
    }

    // =========================================================================
    // INVITES
    // =========================================================================

    match /invites/{inviteToken} {
      // Anyone can read invite (for validation - public endpoint)
      allow read: if true;

      // Only managers can create invites (via API with auth)
      // Updates are done by Cloud Functions when invite is used
      allow create, update, delete: if false;
    }

    // =========================================================================
    // EMPLOYEE USERS (for employee authentication)
    // =========================================================================

    match /employeeUsers/{phoneHash} {
      // Employee can read their own user document
      allow read: if isEmployee();

      // Created/updated by API on OTP verification
      allow create, update, delete: if false;
    }

    // =========================================================================
    // OTP CODES (temporary codes for employee login)
    // =========================================================================

    match /otpCodes/{phoneHash} {
      // OTP codes are managed entirely by the API
      allow read, write: if false;
    }

    // =========================================================================
    // WHATSAPP MESSAGES
    // =========================================================================

    match /whatsappMessages/{messageId} {
      // Only Cloud Functions can read/write WhatsApp messages
      allow read, write: if false;
    }
  }
}
